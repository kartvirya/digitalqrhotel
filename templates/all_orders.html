{% extends 'base.html' %}

{% block title %}All Orders
{% endblock title %}

{% block body %}
{% csrf_token %}

<div style="padding: 15px 50px 15px">

  {% for table, orders in order_by_table.items %}

  <div style="padding: 15px 5px 15px">
    
    {% if table == 'Take Away' %}
    <h3>{{ table }}</h3>
    {% else %}
    <h3>Table No : {{table}}</h3>
    {% endif %}
    <hr>
    <hr>

    {% for o in orders %}

    <h5><p>Order Time: {{ o.order_time }}</p></h5>
    
    <p><strong>Status:</strong> 
        <span class="badge badge-{{ o.status|yesno:'success,warning' }}">
            {{ o.status|title }}
        </span>
    </p>

     {% for item_key, item_values in o.items_json.items %}
    <b><p>{{ item_values.1 }} : {{ item_values.0 }}</p></b>
    {% endfor %}
    <b><p>Total : {{o.price}}</p></b>

    <p>Name: {{ o.name }}</p>
    
    {% if o.special_instructions %}
    <p><strong>Special Instructions:</strong> {{ o.special_instructions }}</p>
    {% endif %}
    
    <div class="btn-group mb-2">
        <button class="btn btn-sm btn-outline-primary" onclick="updateStatus({{ o.order_id }}, 'confirmed')">
            Confirm
        </button>
        <button class="btn btn-sm btn-outline-warning" onclick="updateStatus({{ o.order_id }}, 'preparing')">
            Preparing
        </button>
        <button class="btn btn-sm btn-outline-success" onclick="updateStatus({{ o.order_id }}, 'ready')">
            Ready
        </button>
        <button class="btn btn-sm btn-outline-info" onclick="updateStatus({{ o.order_id }}, 'served')">
            Served
        </button>
    </div>
    
    {% if not o.bill_clear %}
    <button onclick="generateBill('{{table}}')" class="btn btn-success">Generate Bill</button>
    {%else%}
    <b><h5>Bill Cleared</h5></b>
    {% endif %}
    <hr>
    {% endfor %}

    <hr>

  {% endfor %}

  </div>

</div>
{% endblock body %}


{%block js%}

<script>
  function generateBill(table) {
    window.location.href = '/generate_bill?table=' + table;
  }
  
  function updateStatus(orderId, status) {
    fetch(`/update_order_status/${orderId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `status=${status}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating order status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating order status');
    });
  }
</script>

{%endblock js%}